<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malware Analysis Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .header {
            padding: 1rem;
            margin-bottom: 2rem;
            background-color: #e9ecef;
            border-radius: 0.3rem;
        }
        .result-card {
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 1.5rem;
        }
        .card-header-safe {
            background-color: #28a745;
            color: white;
        }
        .card-header-malware {
            background-color: #dc3545;
            color: white;
        }
        .card-header-warning {
            background-color: #ffc107;
            color: black;
        }
        .feature-icon {
            height: 20px;
            margin-right: 5px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .confidence-gauge {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .confidence-fill {
            height: 100%;
            background-color: #007bff;
            border-radius: 10px;
        }
        .confidence-high {
            background-color: #dc3545;
        }
        .confidence-medium {
            background-color: #ffc107;
        }
        .confidence-low {
            background-color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Malware Analysis Results</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Analysis Result</li>
                </ol>
            </nav>
        </div>

        <!-- Main Result Card -->
        <div class="card result-card">
            <div class="card-header {% if result.is_malware %}card-header-malware{% elif result.risk_score > 50 %}card-header-warning{% else %}card-header-safe{% endif %}">
    <div class="d-flex justify-content-between align-items-center">
                    <h2>
                        {% if result.is_malware %}
                            <i class="bi bi-exclamation-triangle-fill"></i> Malware Detected
                        {% elif result.risk_score > 50 %}
                            <i class="bi bi-exclamation-circle-fill"></i> Suspicious File
                        {% else %}
                            <i class="bi bi-check-circle-fill"></i> File Appears Safe
                        {% endif %}
                    </h2>
                    <span class="badge bg-light text-dark">{{ result.file_category|upper }}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>File Information</h4>
                        <table class="table table-striped">
                            <tr>
                                <td><strong>File Name:</strong></td>
                                <td>{{ result.filename }}</td>
                            </tr>
                            <tr>
                                <td><strong>File Size:</strong></td>
                                <td>{{ (result.file_size / 1024)|round(2) }} KB</td>
                            </tr>
                            <tr>
                                <td><strong>File Hash (SHA-256):</strong></td>
                                <td><code>{{ result.file_hash }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Analysis Time:</strong></td>
                                <td>{{ result.timestamp }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>Detection Results</h4>
                        <div class="mb-3">
                            <label for="confidenceGauge" class="form-label">
                                <strong>Confidence: {{ (result.confidence * 100)|round(1) }}%</strong>
                            </label>
                            <div class="confidence-gauge">
                                <div class="confidence-fill 
                                    {% if result.confidence > 0.7 %}confidence-high
                                    {% elif result.confidence > 0.4 %}confidence-medium
                                    {% else %}confidence-low{% endif %}" 
                                    style="width: {{ (result.confidence * 100)|round(1) }}%">
                                </div>
                            </div>
    </div>

                        {% if result.is_malware %}
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-bug-fill"></i> Malware Type: {{ result.malware_type if result.malware_type != "Unknown" else "Unspecified Malware" }}</h5>
                                <p>This file contains malicious code and should not be executed.</p>
                            </div>
                        {% elif result.risk_score > 50 %}
                            <div class="alert alert-warning">
                                <h5><i class="bi bi-exclamation-circle"></i> Risk Score: {{ result.risk_score }}/100</h5>
                                <p>This file shows some suspicious characteristics but was not definitively identified as malware.</p>
                            </div>
                        {% else %}
                            <div class="alert alert-success">
                                <h5><i class="bi bi-shield-check"></i> No Threats Detected</h5>
                                <p>No malicious indicators were found in this file.</p>
                            </div>
                        {% endif %}
                        
                        <div class="mt-3">
                            <h5>Analysis Methods Used:</h5>
                            <ul class="list-group">
                                {% if result.details.ml_model %}
                                    <li class="list-group-item">Machine Learning Model</li>
                                {% endif %}
                                {% if result.details.malware_type %}
                                    <li class="list-group-item">Malware Type Detection</li>
                                {% endif %}
                                {% if result.details.document_analysis %}
                                    <li class="list-group-item">Document Analysis</li>
                                {% endif %}
                                {% if result.details.dynamic_analysis %}
                                    <li class="list-group-item">Dynamic Analysis</li>
                                {% endif %}
                                {% if result.details.virustotal %}
                                    <li class="list-group-item">VirusTotal API Check</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis Accordion -->
        <div class="accordion" id="analysisAccordion">
            {% if result.details.ml_model %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="mlModelHeading">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#mlModelCollapse" aria-expanded="true" aria-controls="mlModelCollapse">
                        ML Model Analysis
                    </button>
                </h2>
                <div id="mlModelCollapse" class="accordion-collapse collapse show" aria-labelledby="mlModelHeading" data-bs-parent="#analysisAccordion">
                    <div class="accordion-body">
                        <p><strong>Prediction:</strong> {% if result.details.ml_model.prediction == 1 %}Malware{% else %}Benign{% endif %}</p>
                        <p><strong>Confidence:</strong> {{ (result.details.ml_model.probability * 100)|round(2) }}%</p>
                        
                        {% if result.details.ml_model.explanation and result.details.ml_model.explanation.feature_contributions %}
                            <h5>Top Contributing Features:</h5>
                            <div id="featureContributionChart" style="height: 300px;"></div>
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const ctx = document.getElementById('featureContributionChart').getContext('2d');
                                    
                                    const contributions = {{ result.details.ml_model.explanation.feature_contributions|tojson }};
                                    const labels = contributions.map(item => item.feature_name);
                                    const values = contributions.map(item => item.contribution);
                                    const colors = values.map(val => val > 0 ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)');
                                    
                                    new Chart(ctx, {
                                        type: 'bar',
                                        data: {
                                            labels: labels,
                                            datasets: [{
                                                label: 'Feature Contribution',
                                                data: values,
                                                backgroundColor: colors,
                                                borderColor: colors.map(c => c.replace('0.7', '1')),
                                                borderWidth: 1
                                            }]
                                        },
                                        options: {
                                            indexAxis: 'y',
                                            responsive: true,
                                            plugins: {
                                                title: {
                                                    display: true,
                                                    text: 'Feature Contributions to Prediction'
                                                }
                                            }
                                        }
                                    });
                                });
                            </script>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if result.details.malware_type %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="malwareTypeHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#malwareTypeCollapse" aria-expanded="false" aria-controls="malwareTypeCollapse">
                        Malware Type Analysis
                    </button>
                </h2>
                <div id="malwareTypeCollapse" class="accordion-collapse collapse" aria-labelledby="malwareTypeHeading" data-bs-parent="#analysisAccordion">
                    <div class="accordion-body">
                        <p><strong>Detected Type:</strong> {{ result.details.malware_type.detected_type }}</p>
                        <p><strong>Confidence:</strong> {{ (result.details.malware_type.confidence * 100)|round(2) }}%</p>
                        
                        {% if result.details.malware_type.all_type_scores %}
                            <h5>Type Scores:</h5>
                            <div id="typeScoresChart" style="height: 300px;"></div>
                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    const ctx = document.getElementById('typeScoresChart').getContext('2d');
                                    
                                    const scores = {{ result.details.malware_type.all_type_scores|tojson }};
                                    const labels = Object.keys(scores);
                                    const values = Object.values(scores);
                                    
                                    new Chart(ctx, {
                                        type: 'bar',
                                        data: {
                                            labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                                            datasets: [{
                                                label: 'Type Score',
                                                data: values,
                                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                                borderColor: 'rgba(54, 162, 235, 1)',
                                                borderWidth: 1
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            scales: {
                                                y: {
                                                    beginAtZero: true,
                                                    max: 1
                                                }
                                            },
                                            plugins: {
                                                title: {
                                                    display: true,
                                                    text: 'Malware Type Scores'
                                                }
                                            }
                                        }
                                    });
                                });
                            </script>
                        {% endif %}
                    </div>
                </div>
                </div>
            {% endif %}
            
            {% if result.details.document_analysis %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="documentAnalysisHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#documentAnalysisCollapse" aria-expanded="false" aria-controls="documentAnalysisCollapse">
                        Document Analysis
                    </button>
                </h2>
                <div id="documentAnalysisCollapse" class="accordion-collapse collapse" aria-labelledby="documentAnalysisHeading" data-bs-parent="#analysisAccordion">
                    <div class="accordion-body">
                        <p><strong>File Type:</strong> {{ result.details.document_analysis.file_type }}</p>
                        <p><strong>Risk Score:</strong> {{ result.details.document_analysis.risk_score.score }}/100 ({{ result.details.document_analysis.risk_score.risk_level }})</p>
                        
                        {% if result.details.document_analysis.has_macros %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> This document contains macros, which can be used for malicious purposes.
                            </div>
                        {% endif %}
                        
                        {% if result.details.document_analysis.has_suspicious_objects %}
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-circle"></i> This document contains suspicious objects or code.
                            </div>
                        {% endif %}
                        
                        {% if result.details.document_analysis.suspicious_indicators %}
                            <h5>Suspicious Indicators:</h5>
                            <ul class="list-group">
                                {% for indicator in result.details.document_analysis.suspicious_indicators %}
                                    <li class="list-group-item list-group-item-warning">{{ indicator }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        
                        {% if result.details.document_analysis.extracted_urls %}
                            <h5 class="mt-3">Extracted URLs:</h5>
                            <ul class="list-group">
                                {% for url in result.details.document_analysis.extracted_urls %}
                                    <li class="list-group-item">{{ url }}</li>
                                {% endfor %}
                            </ul>
                {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if result.details.dynamic_analysis %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="dynamicAnalysisHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dynamicAnalysisCollapse" aria-expanded="false" aria-controls="dynamicAnalysisCollapse">
                        Dynamic Analysis
                    </button>
                </h2>
                <div id="dynamicAnalysisCollapse" class="accordion-collapse collapse" aria-labelledby="dynamicAnalysisHeading" data-bs-parent="#analysisAccordion">
                    <div class="accordion-body">
                        <p><strong>Risk Score:</strong> {{ result.details.dynamic_analysis.risk_score.score }}/100 ({{ result.details.dynamic_analysis.risk_score.risk_level }})</p>
                        
                        {% if result.details.dynamic_analysis.malware_type_indicators %}
                            <p><strong>Likely Malware Type:</strong> {{ result.details.dynamic_analysis.malware_type_indicators.likely_type }}</p>
                        {% endif %}
                        
                        {% if result.details.dynamic_analysis.behavioral_indicators %}
                            <h5>Behavioral Indicators:</h5>
                            <ul class="list-group">
                                {% for indicator in result.details.dynamic_analysis.behavioral_indicators %}
                                    <li class="list-group-item list-group-item-warning">{{ indicator }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        
                        {% if result.details.dynamic_analysis.created_processes %}
                            <h5 class="mt-3">Created Processes:</h5>
                            <ul class="list-group">
                                {% for proc in result.details.dynamic_analysis.created_processes %}
                                    <li class="list-group-item">
                                        <strong>{{ proc.name }}</strong> (PID: {{ proc.pid }})
                                        <br>
                                        <small class="text-muted">{{ proc.exe }}</small>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        
                        {% if result.details.dynamic_analysis.network_activity %}
                            <h5 class="mt-3">Network Connections:</h5>
                            <ul class="list-group">
                                {% for conn in result.details.dynamic_analysis.network_activity %}
                                    <li class="list-group-item">
                                        <strong>{{ conn.local_address }}</strong> â†’ {{ conn.remote_address }}
                                    </li>
                                {% endfor %}
                            </ul>
                {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if result.details.virustotal %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="virustotalHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#virustotalCollapse" aria-expanded="false" aria-controls="virustotalCollapse">
                        VirusTotal Results
                    </button>
                </h2>
                <div id="virustotalCollapse" class="accordion-collapse collapse" aria-labelledby="virustotalHeading" data-bs-parent="#analysisAccordion">
                    <div class="accordion-body">
                        <p><strong>Detection Ratio:</strong> {{ result.details.virustotal.positives }}/{{ result.details.virustotal.total }}</p>
                        <p><strong>Scan Date:</strong> {{ result.details.virustotal.scan_date }}</p>
                        
                        {% if result.details.virustotal.scans %}
                            <h5>Engine Results:</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Engine</th>
                                            <th>Detected</th>
                                            <th>Result</th>
                                            <th>Version</th>
                                            <th>Update</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for engine, scan in result.details.virustotal.scans.items() %}
                                            <tr>
                                                <td>{{ engine }}</td>
                                                <td>
                                                    {% if scan.detected %}
                                                        <span class="badge bg-danger">Yes</span>
        {% else %}
                                                        <span class="badge bg-success">No</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ scan.result if scan.result else '-' }}</td>
                                                <td>{{ scan.version if scan.version else '-' }}</td>
                                                <td>{{ scan.update if scan.update else '-' }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

        <div class="d-flex justify-content-between mt-4 mb-5">
            <a href="/" class="btn btn-secondary">Back to Home</a>
            <a href="/" class="btn btn-primary">Analyze Another File</a>
        </div>

        <div class="mt-4 text-center">
            <a href="{{ url_for('index') }}" class="btn btn-primary">
                <i class="bi bi-upload"></i> Analyze Another File
            </a>
            
            <a href="{{ url_for('explain_result', file_id=file_id) }}" class="btn btn-info mx-2">
                <i class="bi bi-search"></i> View Model Explanation
            </a>
            
            {% if result.is_malware %}
            <a href="{{ url_for('download_report', file_id=file_id) }}" class="btn btn-secondary">
                <i class="bi bi-file-earmark-arrow-down"></i> Download Report
            </a>
            {% endif %}
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</body>
</html>
